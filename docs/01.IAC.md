# Infrastructure as Code (IaC) - Comprehensive Guide

This document provides a detailed explanation of the Terraform-based infrastructure provisioning for the Node.js application on AWS EKS.

## Table of Contents

- [Overview](#overview)
- [Architecture](#architecture)
- [Terraform Modules](#terraform-modules)
- [Environment Management](#environment-management)
- [State Management](#state-management)

## Overview

The infrastructure is built using **Terraform** with a modular design pattern, allowing for:

- **Reusability**: Modules can be reused across different environments
- **Maintainability**: Clear separation of concerns
- **Scalability**: Easy to extend with additional resources
- **Version Control**: Infrastructure changes tracked in Git
- **Automation**: Integrated with CI/CD pipelines

### Technology Stack

| Component | Tool/Service | Version | Purpose |
|-----------|-------------|---------|---------|
| IaC Tool | Terraform | 1.6.0+ | Infrastructure provisioning |
| Cloud Provider | AWS | - | Cloud infrastructure |
| Policy Engine | OPA | 0.59.0+ | Policy validation |
| State Backend | AWS S3 | - | Remote state storage |
| State Locking | DynamoDB | - | Prevent concurrent modifications |

## Architecture

### Infrastructure Components

```
┌─────────────────────────────────────────────────────────────┐
│                         AWS Cloud                            │
│                                                              │
│  ┌────────────────────────────────────────────────────────┐ │
│  │                    VPC (10.0.0.0/16)                   │ │
│  │                                                        │ │
│  │  ┌──────────────────┐      ┌──────────────────┐      │ │
│  │  │  Public Subnet   │      │  Public Subnet   │      │ │
│  │  │  10.0.1.0/24     │      │  10.0.2.0/24     │      │ │
│  │  │  ┌────────────┐  │      │                  │      │ │
│  │  │  │ NAT Gateway│  │      │                  │      │ │
│  │  │  └────────────┘  │      │                  │      │ │
│  │  └────────┬─────────┘      └──────────────────┘      │ │
│  │           │                                           │ │
│  │  ┌────────┴─────────┐      ┌──────────────────┐      │ │
│  │  │ Private Subnet   │      │ Private Subnet   │      │ │
│  │  │ 10.0.11.0/24     │      │ 10.0.12.0/24     │      │ │
│  │  │                  │      │                  │      │ │
│  │  │  ┌───────────┐   │      │  ┌───────────┐   │      │ │
│  │  │  │ EKS Nodes │   │      │  │ EKS Nodes │   │      │ │
│  │  │  └───────────┘   │      │  └───────────┘   │      │ │
│  │  └──────────────────┘      └──────────────────┘      │ │
│  │                                                        │ │
│  │  ┌──────────────────────────────────────────────┐    │ │
│  │  │         EKS Control Plane (Managed)          │    │ │
│  │  └──────────────────────────────────────────────┘    │ │
│  └────────────────────────────────────────────────────────┘ │
│                                                              │
│  ┌────────────────┐  ┌──────────────┐  ┌────────────────┐  │
│  │  ECR Registry  │  │   Secrets    │  │   CloudWatch   │  │
│  │                │  │   Manager    │  │     Logs       │  │
│  └────────────────┘  └──────────────┘  └────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

### Resource Dependencies

```
VPC Module
    ↓
    ├── Internet Gateway
    ├── Public Subnets
    ├── Private Subnets
    ├── NAT Gateway
    └── Route Tables
         ↓
EKS Module
    ↓
    ├── EKS Cluster
    ├── IAM Roles
    ├── Security Groups
    └── Node Groups
         ↓
ECR Module
    ↓
    └── Container Repositories
```

## Terraform Modules

### 1. VPC Module

**Location**: `iac/modules/vpc/`

Creates a production-ready VPC with multi-AZ architecture.

#### Features

- Custom VPC with configurable CIDR
- Public and private subnets across multiple AZs
- Single NAT Gateway for cost efficiency (~$32/month)
- Internet Gateway for public internet access
- Proper route table associations
- DNS support and DNS hostnames enabled

#### Key Resources Created

| Resource | Name Format | Description |
|----------|-------------|-------------|
| VPC | `{project}-{env}-vpc` | Main VPC |
| Internet Gateway | `{project}-{env}-igw` | Internet connectivity |
| Public Subnets | `{project}-{env}-public-subnet-{az}` | Internet-facing resources |
| Private Subnets | `{project}-{env}-private-subnet-{az}` | Internal resources |
| NAT Gateway | `{project}-{env}-nat-gateway` | Outbound internet for private subnets |
| Elastic IP | `{project}-{env}-nat-eip` | NAT Gateway public IP |
| Route Tables | `{project}-{env}-{public/private}-rt` | Network routing |

#### Module Configuration

```hcl
module "vpc" {
  source = "./modules/vpc"

  project            = "ops-solution"
  environment        = "dev"
  vpc_cidr           = "10.0.0.0/16"
  availability_zones = ["ap-southeast-1a", "ap-southeast-1b"]
  public_subnets     = ["10.0.1.0/24", "10.0.2.0/24"]
  private_subnets    = ["10.0.11.0/24", "10.0.12.0/24"]
  enable_nat_gateway = true

  tags = {
    Environment = "dev"
    ManagedBy   = "Terraform"
  }
}
```

#### Inputs

| Variable | Type | Required | Default | Description |
|----------|------|----------|---------|-------------|
| `project` | string | Yes | - | Project name for resource naming |
| `environment` | string | Yes | - | Environment (dev/prod) |
| `vpc_cidr` | string | Yes | - | CIDR block for VPC |
| `availability_zones` | list(string) | Yes | - | List of AZs |
| `public_subnets` | list(string) | Yes | - | Public subnet CIDRs |
| `private_subnets` | list(string) | Yes | - | Private subnet CIDRs |
| `enable_nat_gateway` | bool | No | true | Enable NAT Gateway |
| `tags` | map(string) | No | {} | Additional tags |

#### Outputs

| Output | Description |
|--------|-------------|
| `vpc_id` | VPC identifier |
| `vpc_cidr` | VPC CIDR block |
| `public_subnet_ids` | List of public subnet IDs |
| `private_subnet_ids` | List of private subnet IDs |
| `nat_gateway_id` | NAT Gateway ID |
| `nat_gateway_public_ip` | NAT Gateway Elastic IP |

### 2. EKS Module

**Location**: `iac/modules/eks/`

Creates a managed Kubernetes cluster with proper security configurations.

#### Features

- EKS control plane (managed by AWS)
- Managed node groups with auto-scaling
- IAM roles with least privilege
- Security groups with restrictive rules
- Private/public endpoint configuration
- IMDSv2 enforcement on nodes
- Encrypted EBS volumes

#### Key Resources Created

| Resource | Description |
|----------|-------------|
| EKS Cluster | Kubernetes control plane |
| Node Group | EC2 worker nodes |
| IAM Role (Cluster) | Cluster permissions |
| IAM Role (Nodes) | Node permissions |
| Security Groups | Network access control |
| Launch Template | Node configuration |

#### Module Configuration

```hcl
module "eks" {
  source = "./modules/eks"

  cluster_name       = "${var.project}-${var.environment}-eks"
  environment        = var.environment
  kubernetes_version = "1.28"
  
  subnet_ids = module.vpc.private_subnet_ids

  # Node group configuration
  desired_size   = 2
  min_size       = 1
  max_size       = 4
  instance_types = ["t3.medium"]
  disk_size      = 30

  # API endpoint access
  endpoint_public_access  = true
  endpoint_private_access = true
  public_access_cidrs     = ["0.0.0.0/0"]  # Restrict in production

  tags = var.tags
}
```

#### Security Features

1. **IMDSv2 Required**: Protects against SSRF attacks
2. **Private Subnets**: Nodes not directly accessible from internet
3. **Encrypted Volumes**: EBS volumes encrypted at rest
4. **IAM Roles**: Separate roles for cluster and nodes
5. **Security Groups**: Minimal required ports only

### 3. ECR Module

**Location**: `iac/modules/ecr/`

Creates private container registries for Docker images.

#### Features

- Multiple repositories support
- Image scanning on push
- Encryption (AES256)
- Lifecycle policies for cleanup
- Deletion protection
- Tag immutability

#### Module Configuration

```hcl
module "ecr" {
  source = "./modules/ecr"

  project     = var.project
  environment = var.environment
  
  repository_names = ["nodejs-simple-app"]
  
  image_tag_mutability       = "MUTABLE"
  scan_on_push              = true
  enable_deletion_protection = false  # true for production

  tags = var.tags
}
```

#### Lifecycle Policies

**Tagged Images**: Keep last 30 images
```json
{
  "rulePriority": 1,
  "description": "Keep last 30 images",
  "selection": {
    "tagStatus": "tagged",
    "countType": "imageCountMoreThan",
    "countNumber": 30
  },
  "action": {
    "type": "expire"
  }
}
```

**Untagged Images**: Expire after 7 days
```json
{
  "rulePriority": 2,
  "description": "Expire untagged images after 7 days",
  "selection": {
    "tagStatus": "untagged",
    "countType": "sinceImagePushed",
    "countUnit": "days",
    "countNumber": 7
  },
  "action": {
    "type": "expire"
  }
}
```

## Environment Management

### Directory Structure

```
iac/
├── modules/               # Reusable modules
│   ├── vpc/
│   ├── eks/
│   └── ecr/
├── environment/          # Environment-specific configs
│   ├── dev/
│   │   ├── main.tf      # Dev infrastructure
│   │   ├── variables.tf # Dev variables
│   │   ├── outputs.tf   # Dev outputs
│   │   └── dev.tfvars   # Dev values
│   └── prod/
│       ├── main.tf
│       ├── variables.tf
│       ├── outputs.tf
│       └── prod.tfvars
├── backend-dev.hcl      # Dev state backend
├── backend-prod.hcl     # Prod state backend
└── policies/            # OPA policies
```

### Environment Configuration Differences

| Configuration | Development | Production |
|--------------|-------------|------------|
| VPC CIDR | 10.0.0.0/16 | 10.1.0.0/16 |
| Availability Zones | 2 | 3 |
| Node Count (Desired) | 2 | 3 |
| Node Count (Min) | 1 | 2 |
| Node Count (Max) | 4 | 10 |
| Instance Type | t3.medium | t3.large |
| Disk Size | 30GB | 50GB |
| EKS Public Access | Enabled | Disabled |
| Deletion Protection | Disabled | Enabled |

### Environment Variables

**Common Variables** (`variables.tf`):
```hcl
variable "project" {
  description = "Project name"
  type        = string
}

variable "environment" {
  description = "Environment (dev/prod)"
  type        = string
  validation {
    condition     = contains(["dev", "prod"], var.environment)
    error_message = "Environment must be dev or prod"
  }
}

variable "aws_region" {
  description = "AWS region"
  type        = string
  default     = "ap-southeast-1"
}
```

**Development Values** (`dev.tfvars`):
```hcl
project     = "ops-solution"
environment = "dev"
aws_region  = "ap-southeast-1"

vpc_cidr           = "10.0.0.0/16"
availability_zones = ["ap-southeast-1a", "ap-southeast-1b"]
public_subnets     = ["10.0.1.0/24", "10.0.2.0/24"]
private_subnets    = ["10.0.11.0/24", "10.0.12.0/24"]

node_desired_size = 2
node_min_size     = 1
node_max_size     = 4
```

**Production Values** (`prod.tfvars`):
```hcl
project     = "ops-solution"
environment = "prod"
aws_region  = "ap-southeast-1"

vpc_cidr           = "10.1.0.0/16"
availability_zones = [
  "ap-southeast-1a",
  "ap-southeast-1b",
  "ap-southeast-1c"
]
public_subnets  = ["10.1.1.0/24", "10.1.2.0/24", "10.1.3.0/24"]
private_subnets = ["10.1.11.0/24", "10.1.12.0/24", "10.1.13.0/24"]

node_desired_size = 3
node_min_size     = 2
node_max_size     = 10
```

## State Management

### S3 Backend Configuration

Terraform state is stored remotely in S3 with DynamoDB for locking.

