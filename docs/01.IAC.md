# Infrastructure as Code (IaC) - Comprehensive Guide

This document provides a detailed explanation of the Terraform-based infrastructure provisioning for the Node.js application on AWS EKS.

## Table of Contents

- [Overview](#overview)
- [Architecture](#architecture)
- [Terraform Modules](#terraform-modules)
- [Environment Management](#environment-management)
- [State Management](#state-management)
- [Deployment Guide](#deployment-guide)
- [Best Practices](#best-practices)
- [Troubleshooting](#troubleshooting)

## Overview

The infrastructure is built using **Terraform** with a modular design pattern, allowing for:

- **Reusability**: Modules can be reused across different environments
- **Maintainability**: Clear separation of concerns
- **Scalability**: Easy to extend with additional resources
- **Version Control**: Infrastructure changes tracked in Git
- **Automation**: Integrated with CI/CD pipelines

### Technology Stack

| Component | Tool/Service | Version | Purpose |
|-----------|-------------|---------|---------|
| IaC Tool | Terraform | 1.6.0+ | Infrastructure provisioning |
| Cloud Provider | AWS | - | Cloud infrastructure |
| Policy Engine | OPA | 0.59.0+ | Policy validation |
| State Backend | AWS S3 | - | Remote state storage |
| State Locking | DynamoDB | - | Prevent concurrent modifications |

## Architecture

### Infrastructure Components

```
┌─────────────────────────────────────────────────────────────┐
│                         AWS Cloud                            │
│                                                              │
│  ┌────────────────────────────────────────────────────────┐ │
│  │                    VPC (10.0.0.0/16)                   │ │
│  │                                                        │ │
│  │  ┌──────────────────┐      ┌──────────────────┐      │ │
│  │  │  Public Subnet   │      │  Public Subnet   │      │ │
│  │  │  10.0.1.0/24     │      │  10.0.2.0/24     │      │ │
│  │  │  ┌────────────┐  │      │                  │      │ │
│  │  │  │ NAT Gateway│  │      │                  │      │ │
│  │  │  └────────────┘  │      │                  │      │ │
│  │  └────────┬─────────┘      └──────────────────┘      │ │
│  │           │                                           │ │
│  │  ┌────────┴─────────┐      ┌──────────────────┐      │ │
│  │  │ Private Subnet   │      │ Private Subnet   │      │ │
│  │  │ 10.0.11.0/24     │      │ 10.0.12.0/24     │      │ │
│  │  │                  │      │                  │      │ │
│  │  │  ┌───────────┐   │      │  ┌───────────┐   │      │ │
│  │  │  │ EKS Nodes │   │      │  │ EKS Nodes │   │      │ │
│  │  │  └───────────┘   │      │  └───────────┘   │      │ │
│  │  └──────────────────┘      └──────────────────┘      │ │
│  │                                                        │ │
│  │  ┌──────────────────────────────────────────────┐    │ │
│  │  │         EKS Control Plane (Managed)          │    │ │
│  │  └──────────────────────────────────────────────┘    │ │
│  └────────────────────────────────────────────────────────┘ │
│                                                              │
│  ┌────────────────┐  ┌──────────────┐  ┌────────────────┐  │
│  │  ECR Registry  │  │   Secrets    │  │   CloudWatch   │  │
│  │                │  │   Manager    │  │     Logs       │  │
│  └────────────────┘  └──────────────┘  └────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

### Resource Dependencies

```
VPC Module
    ↓
    ├── Internet Gateway
    ├── Public Subnets
    ├── Private Subnets
    ├── NAT Gateway
    └── Route Tables
         ↓
EKS Module
    ↓
    ├── EKS Cluster
    ├── IAM Roles
    ├── Security Groups
    └── Node Groups
         ↓
ECR Module
    ↓
    └── Container Repositories
```

## Terraform Modules

### 1. VPC Module

**Location**: `iac/modules/vpc/`

Creates a production-ready VPC with multi-AZ architecture.

#### Features

- ✅ Custom VPC with configurable CIDR
- ✅ Public and private subnets across multiple AZs
- ✅ Single NAT Gateway for cost efficiency (~$32/month)
- ✅ Internet Gateway for public internet access
- ✅ Proper route table associations
- ✅ DNS support and DNS hostnames enabled

#### Key Resources Created

| Resource | Name Format | Description |
|----------|-------------|-------------|
| VPC | `{project}-{env}-vpc` | Main VPC |
| Internet Gateway | `{project}-{env}-igw` | Internet connectivity |
| Public Subnets | `{project}-{env}-public-subnet-{az}` | Internet-facing resources |
| Private Subnets | `{project}-{env}-private-subnet-{az}` | Internal resources |
| NAT Gateway | `{project}-{env}-nat-gateway` | Outbound internet for private subnets |
| Elastic IP | `{project}-{env}-nat-eip` | NAT Gateway public IP |
| Route Tables | `{project}-{env}-{public/private}-rt` | Network routing |

#### Module Configuration

```hcl
module "vpc" {
  source = "./modules/vpc"

  project            = "ops-solution"
  environment        = "dev"
  vpc_cidr           = "10.0.0.0/16"
  availability_zones = ["ap-southeast-1a", "ap-southeast-1b"]
  public_subnets     = ["10.0.1.0/24", "10.0.2.0/24"]
  private_subnets    = ["10.0.11.0/24", "10.0.12.0/24"]
  enable_nat_gateway = true

  tags = {
    Environment = "dev"
    ManagedBy   = "Terraform"
  }
}
```

#### Inputs

| Variable | Type | Required | Default | Description |
|----------|------|----------|---------|-------------|
| `project` | string | Yes | - | Project name for resource naming |
| `environment` | string | Yes | - | Environment (dev/prod) |
| `vpc_cidr` | string | Yes | - | CIDR block for VPC |
| `availability_zones` | list(string) | Yes | - | List of AZs |
| `public_subnets` | list(string) | Yes | - | Public subnet CIDRs |
| `private_subnets` | list(string) | Yes | - | Private subnet CIDRs |
| `enable_nat_gateway` | bool | No | true | Enable NAT Gateway |
| `tags` | map(string) | No | {} | Additional tags |

#### Outputs

| Output | Description |
|--------|-------------|
| `vpc_id` | VPC identifier |
| `vpc_cidr` | VPC CIDR block |
| `public_subnet_ids` | List of public subnet IDs |
| `private_subnet_ids` | List of private subnet IDs |
| `nat_gateway_id` | NAT Gateway ID |
| `nat_gateway_public_ip` | NAT Gateway Elastic IP |

### 2. EKS Module

**Location**: `iac/modules/eks/`

Creates a managed Kubernetes cluster with proper security configurations.

#### Features

- ✅ EKS control plane (managed by AWS)
- ✅ Managed node groups with auto-scaling
- ✅ IAM roles with least privilege
- ✅ Security groups with restrictive rules
- ✅ Private/public endpoint configuration
- ✅ IMDSv2 enforcement on nodes
- ✅ Encrypted EBS volumes

#### Key Resources Created

| Resource | Description |
|----------|-------------|
| EKS Cluster | Kubernetes control plane |
| Node Group | EC2 worker nodes |
| IAM Role (Cluster) | Cluster permissions |
| IAM Role (Nodes) | Node permissions |
| Security Groups | Network access control |
| Launch Template | Node configuration |

#### Module Configuration

```hcl
module "eks" {
  source = "./modules/eks"

  cluster_name       = "${var.project}-${var.environment}-eks"
  environment        = var.environment
  kubernetes_version = "1.28"
  
  subnet_ids = module.vpc.private_subnet_ids

  # Node group configuration
  desired_size   = 2
  min_size       = 1
  max_size       = 4
  instance_types = ["t3.medium"]
  disk_size      = 30

  # API endpoint access
  endpoint_public_access  = true
  endpoint_private_access = true
  public_access_cidrs     = ["0.0.0.0/0"]  # Restrict in production

  tags = var.tags
}
```

#### Node Configuration

**Development**:
- Instance Type: `t3.medium` (2 vCPU, 4GB RAM)
- Desired Count: 2
- Min: 1, Max: 4
- Disk: 30GB

**Production**:
- Instance Type: `t3.large` (2 vCPU, 8GB RAM)
- Desired Count: 3
- Min: 2, Max: 10
- Disk: 50GB

#### Security Features

1. **IMDSv2 Required**: Protects against SSRF attacks
2. **Private Subnets**: Nodes not directly accessible from internet
3. **Encrypted Volumes**: EBS volumes encrypted at rest
4. **IAM Roles**: Separate roles for cluster and nodes
5. **Security Groups**: Minimal required ports only

### 3. ECR Module

**Location**: `iac/modules/ecr/`

Creates private container registries for Docker images.

#### Features

- ✅ Multiple repositories support
- ✅ Image scanning on push
- ✅ Encryption (AES256)
- ✅ Lifecycle policies for cleanup
- ✅ Deletion protection
- ✅ Tag immutability

#### Module Configuration

```hcl
module "ecr" {
  source = "./modules/ecr"

  project     = var.project
  environment = var.environment
  
  repository_names = ["nodejs-simple-app"]
  
  image_tag_mutability       = "MUTABLE"
  scan_on_push              = true
  enable_deletion_protection = false  # true for production

  tags = var.tags
}
```

#### Lifecycle Policies

**Tagged Images**: Keep last 30 images
```json
{
  "rulePriority": 1,
  "description": "Keep last 30 images",
  "selection": {
    "tagStatus": "tagged",
    "countType": "imageCountMoreThan",
    "countNumber": 30
  },
  "action": {
    "type": "expire"
  }
}
```

**Untagged Images**: Expire after 7 days
```json
{
  "rulePriority": 2,
  "description": "Expire untagged images after 7 days",
  "selection": {
    "tagStatus": "untagged",
    "countType": "sinceImagePushed",
    "countUnit": "days",
    "countNumber": 7
  },
  "action": {
    "type": "expire"
  }
}
```

## Environment Management

### Directory Structure

```
iac/
├── modules/               # Reusable modules
│   ├── vpc/
│   ├── eks/
│   └── ecr/
├── environment/          # Environment-specific configs
│   ├── dev/
│   │   ├── main.tf      # Dev infrastructure
│   │   ├── variables.tf # Dev variables
│   │   ├── outputs.tf   # Dev outputs
│   │   └── dev.tfvars   # Dev values
│   └── prod/
│       ├── main.tf
│       ├── variables.tf
│       ├── outputs.tf
│       └── prod.tfvars
├── backend-dev.hcl      # Dev state backend
├── backend-prod.hcl     # Prod state backend
└── policies/            # OPA policies
```

### Environment Configuration Differences

| Configuration | Development | Production |
|--------------|-------------|------------|
| VPC CIDR | 10.0.0.0/16 | 10.1.0.0/16 |
| Availability Zones | 2 | 3 |
| Node Count (Desired) | 2 | 3 |
| Node Count (Min) | 1 | 2 |
| Node Count (Max) | 4 | 10 |
| Instance Type | t3.medium | t3.large |
| Disk Size | 30GB | 50GB |
| EKS Public Access | Enabled | Disabled |
| Deletion Protection | Disabled | Enabled |

### Environment Variables

**Common Variables** (`variables.tf`):
```hcl
variable "project" {
  description = "Project name"
  type        = string
}

variable "environment" {
  description = "Environment (dev/prod)"
  type        = string
  validation {
    condition     = contains(["dev", "prod"], var.environment)
    error_message = "Environment must be dev or prod"
  }
}

variable "aws_region" {
  description = "AWS region"
  type        = string
  default     = "ap-southeast-1"
}
```

**Development Values** (`dev.tfvars`):
```hcl
project     = "ops-solution"
environment = "dev"
aws_region  = "ap-southeast-1"

vpc_cidr           = "10.0.0.0/16"
availability_zones = ["ap-southeast-1a", "ap-southeast-1b"]
public_subnets     = ["10.0.1.0/24", "10.0.2.0/24"]
private_subnets    = ["10.0.11.0/24", "10.0.12.0/24"]

node_desired_size = 2
node_min_size     = 1
node_max_size     = 4
```

**Production Values** (`prod.tfvars`):
```hcl
project     = "ops-solution"
environment = "prod"
aws_region  = "ap-southeast-1"

vpc_cidr           = "10.1.0.0/16"
availability_zones = [
  "ap-southeast-1a",
  "ap-southeast-1b",
  "ap-southeast-1c"
]
public_subnets  = ["10.1.1.0/24", "10.1.2.0/24", "10.1.3.0/24"]
private_subnets = ["10.1.11.0/24", "10.1.12.0/24", "10.1.13.0/24"]

node_desired_size = 3
node_min_size     = 2
node_max_size     = 10
```

## State Management

### S3 Backend Configuration

Terraform state is stored remotely in S3 with DynamoDB for locking.

#### Backend Setup (One-time)

```bash
#!/bin/bash
AWS_REGION="ap-southeast-1"
BUCKET_NAME="ops-solution-terraform-state"
DYNAMODB_TABLE="ops-solution-terraform-locks"

# Create S3 bucket
aws s3api create-bucket \
  --bucket $BUCKET_NAME \
  --region $AWS_REGION \
  --create-bucket-configuration LocationConstraint=$AWS_REGION

# Enable versioning
aws s3api put-bucket-versioning \
  --bucket $BUCKET_NAME \
  --versioning-configuration Status=Enabled

# Enable encryption
aws s3api put-bucket-encryption \
  --bucket $BUCKET_NAME \
  --server-side-encryption-configuration \
  '{"Rules":[{"ApplyServerSideEncryptionByDefault":{"SSEAlgorithm":"AES256"}}]}'

# Block public access
aws s3api put-public-access-block \
  --bucket $BUCKET_NAME \
  --public-access-block-configuration \
  "BlockPublicAcls=true,IgnorePublicAcls=true,BlockPublicPolicy=true,RestrictPublicBuckets=true"

# Create DynamoDB table for locking
aws dynamodb create-table \
  --table-name $DYNAMODB_TABLE \
  --attribute-definitions AttributeName=LockID,AttributeType=S \
  --key-schema AttributeName=LockID,KeyType=HASH \
  --billing-mode PAY_PER_REQUEST \
  --region $AWS_REGION
```

#### Backend Configuration Files

**Development** (`backend-dev.hcl`):
```hcl
bucket         = "ops-solution-terraform-state"
key            = "dev/terraform.tfstate"
region         = "ap-southeast-1"
dynamodb_table = "ops-solution-terraform-locks"
encrypt        = true
```

**Production** (`backend-prod.hcl`):
```hcl
bucket         = "ops-solution-terraform-state"
key            = "prod/terraform.tfstate"
region         = "ap-southeast-1"
dynamodb_table = "ops-solution-terraform-locks"
encrypt        = true
```

### State Isolation

Each environment has its own state file:
- Dev: `s3://ops-solution-terraform-state/dev/terraform.tfstate`
- Prod: `s3://ops-solution-terraform-state/prod/terraform.tfstate`

This prevents:
- ✅ Cross-environment interference
- ✅ Accidental production changes
- ✅ State corruption issues

## Deployment Guide

### Prerequisites Checklist

- [ ] AWS CLI installed and configured
- [ ] Terraform >= 1.6.0 installed
- [ ] OPA >= 0.59.0 installed
- [ ] AWS credentials with appropriate permissions
- [ ] S3 backend created
- [ ] DynamoDB table created

### Step-by-Step Deployment

#### 1. Initialize Terraform

```bash
cd iac/environment/dev

# Initialize with backend configuration
terraform init -backend-config=../../backend-dev.hcl

# Verify initialization
ls -la .terraform/
```

#### 2. Review and Plan

```bash
# Format code (if needed)
terraform fmt -recursive

# Validate configuration
terraform validate

# Create execution plan
terraform plan -var-file=dev.tfvars -out=tfplan.binary

# Review plan
terraform show tfplan.binary
```

#### 3. Policy Validation

```bash
# Generate JSON plan for OPA
terraform show -json tfplan.binary > tfplan.json

# Run OPA validation
../../scripts/validate-with-opa.sh tfplan.json

# Expected output:
# ✓ Terraform Best Practices: PASSED
# ✓ Security Policies: PASSED  
# ✓ Cost Control: PASSED
```

#### 4. Apply Changes

```bash
# Apply the plan
terraform apply tfplan.binary

# Or apply with auto-approve (use with caution)
terraform apply -var-file=dev.tfvars -auto-approve
```

#### 5. Verify Deployment

```bash
# View outputs
terraform output

# Expected outputs:
# vpc_id
# eks_cluster_endpoint
# eks_cluster_name
# ecr_repository_urls
```

#### 6. Configure kubectl

```bash
# Update kubeconfig
aws eks update-kubeconfig \
  --name $(terraform output -raw eks_cluster_name) \
  --region ap-southeast-1

# Verify cluster access
kubectl get nodes
kubectl get pods --all-namespaces
```

### Production Deployment

For production, follow additional steps:

1. **Review Changes Thoroughly**
   ```bash
   cd iac/environment/prod
   terraform init -backend-config=../../backend-prod.hcl
   terraform plan -var-file=prod.tfvars -out=tfplan.binary
   ```

2. **Get Approval**
   - Create pull request with plan output
   - Request review from team members
   - Wait for approval

3. **Apply During Maintenance Window**
   ```bash
   terraform apply tfplan.binary
   ```

4. **Verify Health**
   ```bash
   # Check cluster
   kubectl get nodes
   kubectl get pods -A
   
   # Check AWS resources
   aws eks describe-cluster --name <cluster-name>
   ```

## Best Practices

### 1. Module Design

✅ **Do**:
- Keep modules focused and single-purpose
- Use variables for customization
- Provide comprehensive outputs
- Document inputs and outputs
- Include examples

❌ **Don't**:
- Create monolithic modules
- Hardcode values
- Mix concerns (e.g., networking + compute in one module)

### 2. State Management

✅ **Do**:
- Use remote state (S3)
- Enable state locking (DynamoDB)
- Use separate states per environment
- Enable versioning
- Encrypt state

❌ **Don't**:
- Use local state for shared infrastructure
- Share state files manually
- Store state in version control

### 3. Variable Management

✅ **Do**:
- Use `.tfvars` files for values
- Validate variable inputs
- Provide sensible defaults
- Document variable purpose

❌ **Don't**:
- Hardcode values in modules
- Use complex default values
- Store secrets in variables

### 4. Tagging Strategy

All resources should have:
```hcl
tags = {
  Project     = "ops-solution"
  Environment = "dev"
  ManagedBy   = "Terraform"
  Owner       = "DevOps Team"
  CostCenter  = "Engineering"
}
```

### 5. Security

✅ **Do**:
- Use private subnets for workloads
- Enable encryption at rest
- Implement least privilege IAM
- Restrict security group rules
- Enable audit logging

❌ **Don't**:
- Expose resources publicly unnecessarily
- Use overly permissive IAM policies
- Disable encryption
- Allow unrestricted CIDR blocks (0.0.0.0/0) in production

### 6. Cost Optimization

✅ **Do**:
- Right-size instances
- Use single NAT in non-critical envs
- Implement lifecycle policies
- Tag for cost allocation
- Review OPA cost policies

❌ **Don't**:
- Over-provision resources
- Ignore cost warnings
- Leave unused resources running

## Troubleshooting

### Common Issues

#### 1. Backend Initialization Failed

**Error**:
```
Error: Failed to get existing workspaces: NoSuchBucket: The specified bucket does not exist
```

**Solution**:
```bash
# Create S3 bucket first
aws s3api create-bucket \
  --bucket ops-solution-terraform-state \
  --region ap-southeast-1 \
  --create-bucket-configuration LocationConstraint=ap-southeast-1
```

#### 2. State Lock Acquisition Failed

**Error**:
```
Error: Error acquiring the state lock
Lock ID: abc-123-def-456
```

**Solution**:
```bash
# Check who has the lock
aws dynamodb get-item \
  --table-name ops-solution-terraform-locks \
  --key '{"LockID":{"S":"ops-solution-dev/terraform.tfstate"}}'

# Force unlock (use with extreme caution)
terraform force-unlock abc-123-def-456
```

#### 3. Resource Already Exists

**Error**:
```
Error: VPC already exists with this name
```

**Solution**:
```bash
# Import existing resource
terraform import module.vpc.aws_vpc.main vpc-abc123

# Or rename/delete the existing resource
```

#### 4. Insufficient IAM Permissions

**Error**:
```
Error: AccessDenied: User is not authorized to perform: eks:CreateCluster
```

**Solution**:
Ensure IAM user/role has these policies:
- `AmazonEKSClusterPolicy`
- `AmazonEC2FullAccess`
- `AmazonVPCFullAccess`

#### 5. OPA Validation Failed

**Error**:
```
FAIL: EKS cluster must have private endpoint access enabled
```

**Solution**:
```hcl
# In your eks module configuration
endpoint_private_access = true
```

#### 6. Node Group Creation Failed

**Error**:
```
Error: subnet doesn't have enough IP addresses
```

**Solution**:
Use larger subnet CIDR blocks:
```hcl
# Change from /24 (254 hosts) to /22 (1022 hosts)
private_subnets = ["10.0.0.0/22", "10.0.4.0/22"]
```

### Debug Commands

#### Terraform Debugging

```bash
# Enable detailed logging
export TF_LOG=DEBUG
export TF_LOG_PATH=terraform.log

# Run command
terraform plan -var-file=dev.tfvars

# Review log
less terraform.log
```

#### State Inspection

```bash
# List all resources in state
terraform state list

# Show specific resource
terraform state show module.vpc.aws_vpc.main

# Remove resource from state (without destroying)
terraform state rm module.vpc.aws_vpc.main
```

#### AWS Resource Verification

```bash
# Check VPC
aws ec2 describe-vpcs --filters "Name=tag:Name,Values=ops-solution-dev-vpc"

# Check EKS cluster
aws eks describe-cluster --name ops-solution-dev-eks

# Check subnets
aws ec2 describe-subnets --filters "Name=vpc-id,Values=vpc-abc123"
```

### Getting Help

1. **Documentation**:
   - [Terraform AWS Provider](https://registry.terraform.io/providers/hashicorp/aws/latest/docs)
   - [AWS EKS Best Practices](https://aws.github.io/aws-eks-best-practices/)
   
2. **Module README files**:
   - [VPC Module](../iac/modules/vpc/README.md)
   - [EKS Module](../iac/modules/eks/README.md)
   - [ECR Module](../iac/modules/ecr/README.md)

3. **Community**:
   - [Terraform Community Forum](https://discuss.hashicorp.com/c/terraform-core)
   - [AWS Subreddit](https://reddit.com/r/aws)

## Next Steps

After infrastructure is deployed:

1. ✅ Configure kubectl for cluster access
2. ✅ Deploy Kubernetes applications (see [Application Documentation](02.Application.md))
3. ✅ Set up monitoring and logging
4. ✅ Configure backup strategies
5. ✅ Implement disaster recovery procedures

---

**Related Documentation**:
- [Application Deployment Guide](02.Application.md)
- [CI/CD Workflow Guide](03.Workflow.md)
- [OPA Policy Guide](04.OPA.md)
- [Main README](../README.md)

*Last updated: December 10, 2025*

