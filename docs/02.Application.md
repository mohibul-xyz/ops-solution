# Application Deployment Guide

This document covers the Node.js application, containerization, Kubernetes deployment using Helm, and Gateway API configuration.

## Table of Contents

- [Application Overview](#application-overview)
- [Containerization](#containerization)
- [Kubernetes Deployment](#kubernetes-deployment)
- [Helm Chart](#helm-chart)
- [Gateway API](#gateway-api)
- [Secrets Management](#secrets-management)
- [Health Checks](#health-checks)
## Application Overview

### Technology Stack

| Component | Technology | Version | Purpose |
|-----------|-----------|---------|---------|
| Runtime | Node.js | 18 | JavaScript execution |
| Framework | Express | 4.18.2 | Web framework |
| Container | Docker | Alpine-based | Containerization |
| Orchestration | Kubernetes (EKS) | 1.28+ | Container orchestration |
| Package Manager | Helm | 3.13+ | Kubernetes deployment |

### Application Architecture

```
┌─────────────────────────────────────────────────────────┐
│                    Internet/Users                        │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│                    Gateway API                           │
│  ┌──────────────┐   ┌──────────────┐                    │
│  │ GatewayClass │   │   Gateway    │   ┌─────────────┐  │
│  └──────────────┘   └──────────────┘   │ HTTPRoute   │  │
│                                         └─────────────┘  │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│              Kubernetes Service (ClusterIP)              │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│                   Deployment                             │
│  ┌──────────┐   ┌──────────┐   ┌──────────┐            │
│  │   Pod 1  │   │   Pod 2  │   │   Pod N  │            │
│  │          │   │          │   │          │            │
│  │ Node.js  │   │ Node.js  │   │ Node.js  │            │
│  │ Express  │   │ Express  │   │ Express  │            │
│  │          │   │          │   │          │            │
│  │ Port 3000│   │ Port 3000│   │ Port 3000│            │
│  └──────────┘   └──────────┘   └──────────┘            │
└─────────────────────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│              AWS Secrets Manager                         │
│              (API Keys & Credentials)                    │
└─────────────────────────────────────────────────────────┘
```

### Source Code

**Location**: `src/`

#### Application Code (`index.js`)

```javascript
const express = require('express');
const app = express();
const port = process.env.PORT || 3000;

app.get('/health', (req, res) => res.send('OK'));

app.get('/', (req, res) => {
  res.json({ message: "Hello from Node.js app running on Kubernetes!" });
});

app.listen(port, () => {
  console.log(`App listening on port ${port}`);
});
```

#### Dependencies (`package.json`)

```json
{
  "name": "nodejs-simple-app",
  "version": "1.0.0",
  "description": "Simple Node.js app for Kubernetes deployment",
  "main": "index.js",
  "scripts": {
    "start": "node index.js"
  },
  "dependencies": {
    "express": "^4.18.2"
  }
}
```

### API Endpoints

| Endpoint | Method | Description | Response |
|----------|--------|-------------|----------|
| `/` | GET | Main endpoint | `{"message": "Hello from Node.js..."}` |
| `/health` | GET | Health check | `OK` |

## Containerization

### Dockerfile

**Location**: `src/Dockerfile`

```dockerfile
FROM node:18-alpine

WORKDIR /app

COPY package*.json ./

RUN npm install

COPY . .

EXPOSE 3000

CMD ["node", "index.js"]
```


### Image Registry

Images are stored in **AWS Elastic Container Registry**:


## Kubernetes Deployment

### Resource Structure

```
kube/
├── helm/                    # Helm chart (primary deployment method)
│   ├── Chart.yaml
│   ├── values.yaml
│   └── templates/
│       ├── deployment.yaml
│       ├── service.yaml
│       ├── secret.yaml
│       └── _helpers.tpl
└── k8s/                     # Gateway API resources (standalone)
    ├── gatewayclass.yaml
    ├── gateway.yaml
    └── httproute.yaml
```

### Deployment Manifests

#### Deployment (`templates/deployment.yaml`)

Key features:
- **Replicas**: 2 pods for high availability
- **Health Checks**: Startup, liveness, readiness probes
- **Resource Limits**: CPU and memory constraints
- **Security Context**: Non-root user, dropped capabilities
- **Environment Variables**: Port configuration
- **Secrets**: Mounted from AWS Secrets Manager

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nodejs-simple-app
spec:
  replicas: 2
  selector:
    matchLabels:
      app: nodejs-simple-app
  template:
    metadata:
      labels:
        app: nodejs-simple-app
    spec:
      securityContext:
        fsGroup: 1001
      containers:
      - name: nodejs-simple-app
        image: ghcr.io/username/ops-solution:latest
        ports:
        - containerPort: 3000
        env:
        - name: PORT
          value: "3000"
        - name: API_KEY
          valueFrom:
            secretKeyRef:
              name: api-key-secret
              key: API_KEY
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 500m
            memory: 512Mi
        startupProbe:
          httpGet:
            path: /health
            port: 3000
          initialDelaySeconds: 10
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 6
        livenessProbe:
          httpGet:
            path: /health
            port: 3000
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /health
            port: 3000
          initialDelaySeconds: 5
          periodSeconds: 5
        securityContext:
          runAsNonRoot: true
          runAsUser: 1001
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
```

#### Service (`templates/service.yaml`)

```yaml
apiVersion: v1
kind: Service
metadata:
  name: nodejs-simple-app
spec:
  type: ClusterIP
  ports:
  - port: 3000
    targetPort: 3000
    protocol: TCP
    name: http
  selector:
    app: nodejs-simple-app
```

**Service Type**: `ClusterIP`
- Internal access only
- Exposed via Gateway API
- More secure than LoadBalancer

## Helm Chart

### Chart Structure

**Location**: `kube/helm/`

```
helm/
├── Chart.yaml          # Chart metadata
├── values.yaml         # Default values
└── templates/
    ├── _helpers.tpl    # Template helpers
    ├── deployment.yaml # Deployment manifest
    ├── service.yaml    # Service manifest
    └── secret.yaml     # Secret manifest
```

### Chart Metadata (`Chart.yaml`)

```yaml
apiVersion: v2
name: nodejs-simple-app
description: A Helm chart for Node.js simple application on Kubernetes
type: application
version: 1.0.0
appVersion: "1.0.0"
```

### Values File (`values.yaml`)

```yaml
replicaCount: 2

image:
  repository: ghcr.io/username/ops-solution
  pullPolicy: IfNotPresent
  tag: "latest"

service:
  type: ClusterIP
  port: 3000
  targetPort: 3000

resources:
  limits:
    cpu: 500m
    memory: 512Mi
  requests:
    cpu: 100m
    memory: 128Mi

env:
  - name: PORT
    value: "3000"

startupProbe:
  httpGet:
    path: /health
    port: 3000
  initialDelaySeconds: 10
  periodSeconds: 5
  timeoutSeconds: 3
  failureThreshold: 6

livenessProbe:
  httpGet:
    path: /health
    port: 3000
  initialDelaySeconds: 30
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3

readinessProbe:
  httpGet:
    path: /health
    port: 3000
  initialDelaySeconds: 5
  periodSeconds: 5
  timeoutSeconds: 3
  failureThreshold: 3

secret:
  apiKey:
    enabled: true
    create: true
    value: ""  # Set via --set-string during deployment
    mountPath: "/etc/secrets"

securityContext:
  capabilities:
    drop:
    - ALL
  readOnlyRootFilesystem: false
  runAsNonRoot: true
  runAsUser: 1001
  allowPrivilegeEscalation: false
```

### Customizing Values

#### Development Override

```yaml
# values-dev.yaml
replicaCount: 1

resources:
  limits:
    cpu: 250m
    memory: 256Mi
  requests:
    cpu: 50m
    memory: 64Mi
```

#### Production Override

```yaml
# values-prod.yaml
replicaCount: 3

image:
  tag: "v1.2.3"

resources:
  limits:
    cpu: 1000m
    memory: 1Gi
  requests:
    cpu: 200m
    memory: 256Mi

affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
    - weight: 100
      podAffinityTerm:
        labelSelector:
          matchExpressions:
          - key: app
            operator: In
            values:
            - nodejs-simple-app
        topologyKey: kubernetes.io/hostname
```

## Gateway API

### Why Gateway API over Ingress?

| Feature | Ingress | Gateway API |
|---------|---------|-------------|
| **Design** | Monolithic | Role-oriented |
| **Flexibility** | Limited | Highly extensible |
| **Traffic Management** | Basic | Advanced (header, query params) |
| **Multiple Protocols** | HTTP/HTTPS only | HTTP, HTTPS, TCP, UDP, gRPC |
| **Cross-Namespace** | Limited | Native support |
| **Standards** | Vendor-specific | Standardized API |
| **Future** | Maintenance mode | Active development |

### Gateway API Resources

#### 1. GatewayClass

**Location**: `kube/k8s/gatewayclass.yaml`

Defines which controller manages the Gateway.

```yaml
apiVersion: gateway.networking.k8s.io/v1
kind: GatewayClass
metadata:
  name: nodejs-app-gateway-class
spec:
  controllerName: gateway.networking.k8s.io/gateway-controller
  description: "Gateway class for nodejs-simple-app"
```

**Controller Options**:
- AWS Load Balancer Controller
- Istio Gateway
- Nginx Gateway
- Envoy Gateway

#### 2. Gateway

**Location**: `kube/k8s/gateway.yaml`

Configures the load balancer with listeners.

```yaml
apiVersion: gateway.networking.k8s.io/v1
kind: Gateway
metadata:
  name: nodejs-app-gateway
  namespace: default
spec:
  gatewayClassName: nodejs-app-gateway-class
  listeners:
    - name: https
      protocol: HTTPS
      port: 443
      hostname: "api.mohibulalam.xyz"
      tls:
        mode: Terminate
        certificateRefs:
          - kind: Secret
            name: api-mohibulalam-xyz-tls
            namespace: default
      allowedRoutes:
        namespaces:
          from: Same
    - name: http
      protocol: HTTP
      port: 80
      hostname: "api.mohibulalam.xyz"
      allowedRoutes:
        namespaces:
          from: Same
```

**Features**:
- HTTPS termination with TLS certificate
- HTTP listener for redirect (optional)
- Hostname-based routing
- Namespace isolation

#### 3. HTTPRoute

**Location**: `kube/k8s/httproute.yaml`

Defines routing rules to backend services.

```yaml
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: nodejs-app-httproute
  namespace: default
spec:
  parentRefs:
    - name: nodejs-app-gateway
      namespace: default
      sectionName: https
  hostnames:
    - "api.mohibulalam.xyz"
  rules:
    - matches:
        - path:
            type: PathPrefix
            value: /
      backendRefs:
        - name: nodejs-simple-app
          port: 3000
          weight: 100
```

**Advanced Routing Examples**:

```yaml
# Path-based routing
rules:
  - matches:
      - path:
          type: PathPrefix
          value: /api
    backendRefs:
      - name: api-service
        port: 8080

  - matches:
      - path:
          type: PathPrefix
          value: /admin
    backendRefs:
      - name: admin-service
        port: 9090

# Header-based routing
rules:
  - matches:
      - headers:
          - name: x-version
            value: v2
    backendRefs:
      - name: app-v2
        port: 3000

# Query parameter routing
rules:
  - matches:
      - queryParams:
          - name: beta
            value: "true"
    backendRefs:
      - name: beta-app
        port: 3000
```

### Installing Gateway API CRDs

```bash
# Install standard version
kubectl apply -f https://github.com/kubernetes-sigs/gateway-api/releases/download/v1.0.0/standard-install.yaml

# Verify installation
kubectl get crd | grep gateway

# Expected output:
# gatewayclasses.gateway.networking.k8s.io
# gateways.gateway.networking.k8s.io
# httproutes.gateway.networking.k8s.io
```

## Secrets Management

### AWS Secrets Manager Integration

Secrets are stored in AWS Secrets Manager and fetched during CI/CD deployment.


#### Secret Mounting

Secrets are mounted as files in the container:

```yaml
volumeMounts:
  - name: api-key-secret
    mountPath: /etc/secrets
    readOnly: true

volumes:
  - name: api-key-secret
    secret:
      secretName: api-key-secret
      items:
        - key: API_KEY
          path: api-key
      defaultMode: 0400  # Read-only for owner
```

**Access in Application**:
```javascript
const fs = require('fs');
const apiKey = fs.readFileSync('/etc/secrets/api-key', 'utf8');
```

Or via environment variable:
```javascript
const apiKey = process.env.API_KEY;
```

## Health Checks

### Types of Probes

#### 1. Startup Probe

**Purpose**: Protects slow-starting containers

```yaml
startupProbe:
  httpGet:
    path: /health
    port: 3000
  initialDelaySeconds: 10
  periodSeconds: 5
  timeoutSeconds: 3
  failureThreshold: 6  # 30 seconds total (5s * 6)
```

- Runs first, before liveness/readiness
- Allows up to 30 seconds for app to start
- Other probes disabled until startup succeeds

#### 2. Liveness Probe

**Purpose**: Restarts unhealthy containers

```yaml
livenessProbe:
  httpGet:
    path: /health
    port: 3000
  initialDelaySeconds: 30
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3  # Restart after 30s (10s * 3)
```

- Checks if application is alive
- Restarts container if fails
- Should detect hung processes, deadlocks

#### 3. Readiness Probe

**Purpose**: Controls traffic routing

```yaml
readinessProbe:
  httpGet:
    path: /health
    port: 3000
  initialDelaySeconds: 5
  periodSeconds: 5
  timeoutSeconds: 3
  failureThreshold: 3  # Remove from service after 15s (5s * 3)
```

- Checks if app can handle requests
- Removes pod from service if fails
- Doesn't restart container

### Health Check Flow

```
Container Start
      ↓
  Startup Probe (checks every 5s, max 6 failures = 30s)
      ↓
   Success!
      ↓
  ┌─────────────────────┐
  │  Liveness Probe     │ ← Checks every 10s
  │  (Restart if fail)  │    Restarts after 3 failures
  └─────────────────────┘
      ↓
  ┌─────────────────────┐
  │  Readiness Probe    │ ← Checks every 5s
  │  (Route traffic)    │    Removes from service after 3 failures
  └─────────────────────┘
```

## Scaling and Resources

### Resource Management

#### CPU and Memory

```yaml
resources:
  requests:
    cpu: 100m      # 0.1 CPU core (minimum guaranteed)
    memory: 128Mi  # 128 MiB (minimum guaranteed)
  limits:
    cpu: 500m      # 0.5 CPU core (maximum allowed)
    memory: 512Mi  # 512 MiB (maximum allowed)
```

**Request vs Limit**:
- **Request**: Minimum guaranteed resources
- **Limit**: Maximum allowed resources
- **Throttling**: CPU is throttled, memory causes OOMKill

#### Quality of Service Classes

| Class | Condition | Eviction Priority |
|-------|-----------|------------------|
| **Guaranteed** | requests = limits | Lowest (last to evict) |
| **Burstable** | requests < limits | Medium |
| **BestEffort** | No requests/limits | Highest (first to evict) |

### Horizontal Pod Autoscaler (HPA)

**Not included by default, but can be added**:

```yaml
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: nodejs-simple-app-hpa
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: nodejs-simple-app
  minReplicas: 2
  maxReplicas: 10
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
      - type: Percent
        value: 50
        periodSeconds: 60
```

**Enable in Helm**:
```yaml
# values.yaml
autoscaling:
  enabled: true
  minReplicas: 2
  maxReplicas: 10
  targetCPUUtilizationPercentage: 70
  targetMemoryUtilizationPercentage: 80
```

### Vertical Pod Autoscaler (VPA)

**For right-sizing resources**:

```bash
# Install VPA
kubectl apply -f https://github.com/kubernetes/autoscaler/releases/download/vertical-pod-autoscaler-0.13.0/vpa-v0.13.0.yaml

# Create VPA
kubectl apply -f - <<EOF
apiVersion: autoscaling.k8s.io/v1
kind: VerticalPodAutoscaler
metadata:
  name: nodejs-simple-app-vpa
spec:
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: nodejs-simple-app
  updatePolicy:
    updateMode: "Auto"
EOF

# Get recommendations
kubectl describe vpa nodejs-simple-app-vpa
```

## Deployment Guide

### Prerequisites

- EKS cluster running
- kubectl configured
- Helm 3.13+ installed
- Gateway API CRDs installed
- Secrets in AWS Secrets Manager

