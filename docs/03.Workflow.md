# CI/CD Workflow Guide

This document provides a comprehensive guide to the GitHub Actions CI/CD pipelines for both application and infrastructure deployment.

## Table of Contents

- [Overview](#overview)
- [Architecture](#architecture)
- [Application Pipeline](#application-pipeline)
- [Infrastructure Pipeline](#infrastructure-pipeline)
- [GitHub OIDC Setup](#github-oidc-setup)
- [Secrets Configuration](#secrets-configuration)
## Overview

The project uses **GitHub Actions** for continuous integration and deployment with two separate workflows:

1. **Application CI/CD** (`ci-cd.yml`) - Builds, tests, and deploys the Node.js application
2. **Infrastructure CI/CD** (`terraform.yml`) - Validates and deploys Terraform infrastructure

### Key Features

**Automated Testing**: Every code change is tested automatically  
**OPA Policy Validation**: Infrastructure changes validated against policies  
**Multi-Environment**: Separate dev and prod environments  
**Atomic Deployments**: Automatic rollback on failure  
**Security**: OIDC authentication, no long-lived credentials  
**Caching**: Build and registry caching for speed  
**Cost Optimization**: Efficient resource usage

## Architecture

### Pipeline Overview

```
┌─────────────────────────────────────────────────────────────┐
│                       Developer                              │
│                           ↓                                  │
│                    Git Push/PR                               │
└────────────────────┬────────────────────────────────────────┘
                     │
         ┌───────────┴──────────┐
         │                      │
    ┌────▼────┐           ┌────▼────┐
    │ Changed │           │ Changed │
    │   src/  │           │   iac/  │
    │  kube/  │           │         │
    └────┬────┘           └────┬────┘
         │                     │
    ┌────▼─────────┐    ┌─────▼────────┐
    │ Application  │    │ Infrastructure│
    │   Pipeline   │    │   Pipeline    │
    │              │    │               │
    │ 1. Build     │    │ 1. Format     │
    │ 2. Test      │    │ 2. Validate   │
    │ 3. Deploy    │    │ 3. Plan       │
    │              │    │ 4. OPA Check  │
    │              │    │ 5. Apply      │
    └────┬─────────┘    └─────┬────────┘
         │                     │
         ▼                     ▼
┌─────────────────────────────────────┐
│          AWS EKS Cluster             │
│  ┌──────────┐      ┌──────────┐     │
│  │   App    │      │   VPC    │     │
│  │  Pods    │      │   EKS    │     │
│  └──────────┘      └──────────┘     │
└─────────────────────────────────────┘
```

### Workflow Files

**Location**: `.github/workflows/`

| File | Purpose | Triggers |
|------|---------|----------|
| `ci-cd.yml` | Application deployment | Push to main/develop, PRs on src/kube |
| `terraform.yml` | Infrastructure deployment | Push to main, PRs on iac/ |

## Application Pipeline

**File**: `.github/workflows/ci-cd.yml`

### Pipeline Stages

```
┌──────────────────────────────────────────────────────────┐
│                    Build and Test Job                     │
│                                                           │
│  1. Checkout Code                                         │
│  2. Setup Docker Buildx                                   │
│  3. Login to GHCR                                         │
│  4. Extract Metadata (tags, labels)                       │
│  5. Build & Push Image (with caching)                     │
│     ├─ Registry Cache                                     │
│     └─ GitHub Actions Cache                               │
│  6. Output: image-tag, image-digest                       │
└────────────────────┬─────────────────────────────────────┘
                     │
                     ▼
┌──────────────────────────────────────────────────────────┐
│                        Test Job                           │
│                                                           │
│  1. Login to GHCR                                         │
│  2. Pull Built Image                                      │
│  3. Run Container                                         │
│  4. Health Check Test (15 attempts, 2s interval)          │
│  5. API Endpoint Test                                     │
│  6. Cleanup                                               │
└────────────────────┬─────────────────────────────────────┘
                     │
                     ▼
┌──────────────────────────────────────────────────────────┐
│                       Deploy Job                          │
│                  (main branch only)                       │
│                                                           │
│  1. Checkout Code (kube/helm)                             │
│  2. Configure AWS Credentials (OIDC)                      │
│  3. Fetch Secrets from AWS Secrets Manager                │
│  4. Setup kubectl                                         │
│  5. Setup Helm                                            │
│  6. Configure kubectl for EKS                             │
│  7. Helm Upgrade (atomic)                                 │
│  8. Verify Deployment                                     │
│  9. Rollback on Failure                                   │
└──────────────────────────────────────────────────────────┘
```
## Infrastructure Pipeline

**File**: `.github/workflows/terraform.yml`

### Pipeline Stages

```
┌──────────────────────────────────────────────────────────┐
│              Terraform Plan & OPA Validation              │
│                  (Runs for dev AND prod)                  │
│                                                           │
│  1. Checkout Code                                         │
│  2. Configure AWS Credentials (OIDC)                      │
│  3. Setup Terraform                                       │
│  4. Setup OPA                                             │
│  5. Terraform Format Check                                │
│  6. Terraform Init (with backend)                         │
│  7. Terraform Validate                                    │
│  8. Terraform Plan (output binary)                        │
│  9. Generate JSON Plan                                    │
│ 10. Run OPA Policy Validation                             │
│     ├─ terraform.rego (best practices)                    │
│     ├─ security.rego (security policies)                  │
│     └─ cost_control.rego (cost policies)                  │
│ 11. Upload Plan Artifacts                                 │
│ 12. Fail if any step failed                               │
└────────────────────┬─────────────────────────────────────┘
                     │
                     ▼
┌──────────────────────────────────────────────────────────┐
│                   Terraform Apply                         │
│             (main branch, dev env only)                   │
│                                                           │
│  1. Checkout Code                                         │
│  2. Configure AWS Credentials (OIDC)                      │
│  3. Setup Terraform                                       │
│  4. Terraform Init                                        │
│  5. Download Plan Artifact                                │
│  6. Terraform Apply (plan file)                           │
│  7. Notify Success/Failure                                │
└──────────────────────────────────────────────────────────┘
```

### Architecture

```
┌─────────────────────────────────────────────────────────┐
│                   GitHub Actions                         │
│                                                          │
│  Workflow requests AWS access                            │
│         ↓                                                │
│  GitHub generates OIDC token with:                       │
│    - Repository info                                     │
│    - Branch/tag info                                     │
│    - Workflow info                                       │
└────────────────────┬────────────────────────────────────┘
                     │ OIDC Token
                     ▼
┌─────────────────────────────────────────────────────────┐
│                    AWS STS                               │
│                                                          │
│  Validates OIDC token against:                           │
│    - OIDC provider thumbprint                            │
│    - IAM role trust policy                               │
│    - Repository/branch conditions                        │
│         ↓                                                │
│  Issues temporary credentials (1 hour)                   │
└────────────────────┬────────────────────────────────────┘
                     │ Temporary Credentials
                     ▼
┌─────────────────────────────────────────────────────────┐
│                  AWS Resources                           │
│                                                          │
│  Workflow can now access AWS with temporary credentials  │
└─────────────────────────────────────────────────────────┘
```

### Step-by-Step Setup

#### 1. Create OIDC Provider (One-time)

```bash
aws iam create-open-id-connect-provider \
  --url https://token.actions.githubusercontent.com \
  --client-id-list sts.amazonaws.com \
  --thumbprint-list 6938fd4d98bab03faadb97b34396831e3780aea1
```

**Verify**:
```bash
aws iam list-open-id-connect-providers
```

#### 2. Create Trust Policy

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "Federated": "arn:aws:iam::123456789012:oidc-provider/token.actions.githubusercontent.com"
      },
      "Action": "sts:AssumeRoleWithWebIdentity",
      "Condition": {
        "StringEquals": {
          "token.actions.githubusercontent.com:aud": "sts.amazonaws.com"
        },
        "StringLike": {
          "token.actions.githubusercontent.com:sub": "repo:username/ops-solution:*"
        }
      }
    }
  ]
}
```

**Key Parts**:
- `Federated`: OIDC provider ARN
- `Action`: Allow assuming role via OIDC
- `Condition`: Restrict to specific repository

**More Restrictive Example** (main branch only):
```json
"StringLike": {
  "token.actions.githubusercontent.com:sub": "repo:username/ops-solution:ref:refs/heads/main"
}
```

#### 3. Create IAM Roles

**For Development**:
```bash
# Create role
aws iam create-role \
  --role-name github-actions-terraform-dev \
  --assume-role-policy-document file://trust-policy.json \
  --description "GitHub Actions role for dev deployments"

# Attach policies
aws iam attach-role-policy \
  --role-name github-actions-terraform-dev \
  --policy-arn arn:aws:iam::aws:policy/AdministratorAccess

# Note: Use more restrictive policies in production
```

**For Production**:
```bash
# Create role
aws iam create-role \
  --role-name github-actions-terraform-prod \
  --assume-role-policy-document file://trust-policy.json \
  --description "GitHub Actions role for prod deployments"

# Attach policies
aws iam attach-role-policy \
  --role-name github-actions-terraform-prod \
  --policy-arn arn:aws:iam::aws:policy/AdministratorAccess
```

#### 4. Get Role ARNs

```bash
aws iam get-role \
  --role-name github-actions-terraform-dev \
  --query 'Role.Arn' \
  --output text
```

**Example Output**:
```
arn:aws:iam::123456789012:role/github-actions-terraform-dev
```

#### 5. Add to GitHub Secrets

Navigate to: `Settings` → `Secrets and variables` → `Actions`

Add secrets:
- `AWS_ROLE_ARN`: Dev role ARN
- `AWS_PROD_ROLE_ARN`: Prod role ARN
- `AWS_REGION`: `ap-southeast-1`
- `SECRET_MANAGER_NAME`: Name of secret in AWS
- `EKS_CLUSTER_NAME`: Name of EKS cluster

### Using OIDC in Workflows

```yaml
- name: Configure AWS Credentials
  uses: aws-actions/configure-aws-credentials@v4
  with:
    role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
    aws-region: ${{ secrets.AWS_REGION }}
    role-session-name: workflow-${{ github.run_id }}

- name: Verify Credentials
  run: |
    aws sts get-caller-identity
    # Output:
    # {
    #   "UserId": "AROA...:workflow-123456",
    #   "Account": "123456789012",
    #   "Arn": "arn:aws:sts::123456789012:assumed-role/github-actions-terraform-dev/workflow-123456"
    # }
```

## Secrets Configuration

### Required GitHub Secrets

| Secret Name | Description | Example | Used By |
|-------------|-------------|---------|---------|
| `AWS_ROLE_ARN` | IAM role for dev/staging | `arn:aws:iam::123...:role/github-...` | Both pipelines |
| `AWS_PROD_ROLE_ARN` | IAM role for production | `arn:aws:iam::123...:role/github-...` | Terraform pipeline |
| `AWS_REGION` | AWS region | `ap-southeast-1` | Both pipelines |
| `SECRET_MANAGER_NAME` | Secrets Manager secret name | `ops-solution-api-keys` | App pipeline |
| `EKS_CLUSTER_NAME` | EKS cluster name | `ops-solution-dev-eks` | App pipeline |

### AWS Secrets Manager

**Creating Secrets**:
```bash
# Create secret with JSON value
aws secretsmanager create-secret \
  --name ops-solution-api-keys \
  --description "API keys for application" \
  --secret-string '{"API_KEY":"super-secret-key-123"}' \
  --region ap-southeast-1

# Update secret
aws secretsmanager update-secret \
  --secret-id ops-solution-api-keys \
  --secret-string '{"API_KEY":"new-secret-key-456"}' \
  --region ap-southeast-1

# Enable rotation (optional)
aws secretsmanager rotate-secret \
  --secret-id ops-solution-api-keys \
  --rotation-lambda-arn arn:aws:lambda:...
```

**Retrieving in Pipeline**:
```bash
SECRET_VALUE=$(aws secretsmanager get-secret-value \
  --secret-id ops-solution-api-keys \
  --region ap-southeast-1 \
  --query SecretString \
  --output text)

API_KEY=$(echo "$SECRET_VALUE" | jq -r '.API_KEY')

# Mask in logs
echo "::add-mask::$API_KEY"
```

## Workflow Triggers

### Application Pipeline Triggers

```yaml
on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'src/**'
      - 'kube/**'
      - '.github/workflows/**'
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'src/**'
      - 'kube/**'
```

| Event | Branch | Action |
|-------|--------|--------|
| Push | `main` | Build → Test → Deploy |
| Push | `develop` | Build → Test only |
| PR | Any → `main` | Build → Test only |
| PR | Any → `develop` | Build → Test only |

### Infrastructure Pipeline Triggers

```yaml
on:
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'iac/**'
  push:
    branches:
      - main
    paths:
      - 'iac/**'
  workflow_dispatch:
    inputs:
      environment:
        type: choice
        options: [dev, prod]
```

| Event | Branch | Action |
|-------|--------|--------|
| PR | Any → `main` | Plan both envs + OPA |
| Push | `main` | Plan + Apply (dev only) |
| Manual | - | Plan + Apply (selected env) |

### Manual Workflow Dispatch

**Running manually**:
1. Go to Actions tab
2. Select workflow
3. Click "Run workflow"
4. Select environment
5. Click "Run workflow" button

**Via GitHub CLI**:
```bash
gh workflow run terraform.yml \
  -f environment=prod
```

