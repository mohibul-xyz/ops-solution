# Open Policy Agent (OPA) - Policy as Code

This document explains how Open Policy Agent (OPA) validates infrastructure changes in this project.

## Table of Contents

- [Overview](#overview)
- [Why Policy as Code](#why-policy-as-code)
- [How OPA Works](#how-opa-works)
- [Policy Categories](#policy-categories)
- [Validation Workflow](#validation-workflow)

## Overview

Open Policy Agent (OPA) is an automated policy enforcement system that validates infrastructure changes before deployment. It acts as a gatekeeper that examines every infrastructure change against predefined rules.

**What OPA Does:**
- Examines proposed infrastructure changes
- Validates changes against security, cost, and best practice rules
- Approves or rejects changes based on compliance
- Provides detailed feedback on violations

**Key Benefits:**
- Prevents misconfigurations before deployment
- Enforces consistent standards across all environments
- Controls costs by limiting expensive resources
- Automates security compliance checks
- Eliminates manual review bottlenecks

## Why Policy as Code

### Traditional Approach

```
Developer writes Terraform
    ↓
Manual code review (slow, inconsistent)
    ↓
Deploy to AWS
    ↓
Discover issue in production
    ↓
Emergency rollback and fix
```

**Problems:**
- Manual reviews are slow and error-prone
- Inconsistent enforcement between reviewers
- Issues discovered too late
- Rules exist as tribal knowledge
- No audit trail of decisions

### Policy-as-Code Approach

```
Developer writes Terraform
    ↓
OPA validates automatically (under 30 seconds)
    ↓
Pass: Deploy | Fail: Fix issues
    ↓
Only compliant infrastructure reaches production
```

**Advantages:**
- Instant, consistent validation
- Issues caught before deployment
- Rules documented in code
- Same checks every time
- Complete audit trail

## How OPA Works

### The Validation Process

OPA validates infrastructure in three steps:

**Step 1: Generate Plan**
- Terraform creates a detailed plan of what will change
- Plan includes all resources to be created, modified, or deleted
- Plan converted to JSON format for analysis
- No actual changes made yet

**Step 2: Evaluate Against Policies**
- OPA loads policy rules from three policy files
- Each resource in the plan is examined
- Rules are applied to check compliance
- Violations and warnings are collected

**Step 3: Decision**
- Violations found: Deployment blocked, must fix issues
- Only warnings: Deployment proceeds with alerts
- No issues: Deployment continues normally

### Policy Evaluation Flow

```
Terraform Plan (JSON)
    ↓
OPA Engine
    ↓
Load Policy Rules
├── Best Practices (tagging, configuration)
├── Security (encryption, access control)
└── Cost Control (instance limits, spending)
    ↓
Check Each Resource
    ↓
Generate Results
├── Violations (blocking)
├── Warnings (non-blocking)
└── Pass/Fail Decision
    ↓
Allow or Block Deployment
```

## Policy Categories

### 1. Best Practices Policies

**Purpose:** Enforce infrastructure standards and maintainability

**What is checked:**
- All resources must have required tags (Environment, ManagedBy)
- VPCs must have DNS support enabled
- EKS clusters must have private endpoint access
- Node volumes must be encrypted
- CloudWatch logs must have retention periods
- Private subnets must have NAT gateways

### 2. Security Policies

**Purpose:** Enforce security standards and prevent vulnerabilities

**What is checked:**
- S3 buckets must have encryption enabled
- EBS volumes must be encrypted
- RDS instances must use encrypted storage
- Security groups cannot allow unrestricted access to sensitive ports
- EC2 instances must use IMDSv2
- Launch templates must require secure metadata service

**Sensitive ports protected:**
- 22 (SSH)
- 3389 (RDP)
- 3306 (MySQL)
- 5432 (PostgreSQL)
- 1433 (SQL Server)
- 6379 (Redis)
- 27017 (MongoDB)

### 3. Cost Control Policies

**Purpose:** Prevent unexpected cloud spending

**What is checked:**
- Development environments limited to small instance types (t2/t3)
- Production environments use approved instance types only
- Development disk sizes limited to 50GB
- Node counts monitored for excessive scaling
- Warnings issued for expensive resources (NAT Gateways, EKS)

**Instance restrictions:**
- Dev: t3.micro, t3.small, t3.medium, t2.micro, t2.small, t2.medium
- Prod: m6a.large, m6a.xlarge

## Validation Workflow

### In CI/CD Pipeline

OPA validation runs automatically in the GitHub Actions workflow:

**Trigger:** Pull request or push to main branch

**Process:**
1. Terraform generates plan
2. Plan converted to JSON
3. OPA validates against all policies
4. Results reported to GitHub
5. Deployment proceeds only if validation passes

**Timing:**
- Validation completes in under 30 seconds
- Runs before any infrastructure changes
- Production deploys blocked until policies pass

### Policy Enforcement

**Violations (Blocking):**
- Deployment cannot proceed
- Pull request cannot merge
- Must fix issues before continuing
- Examples: Missing encryption, wrong instance type, missing tags

**Warnings (Non-blocking):**
- Deployment can proceed
- Issues logged for review
- Best practices recommendations
- Examples: Cost warnings, optimization suggestions

### Integration Points

**Local Development:**
- Developers can run OPA validation locally before commit
- Immediate feedback during development
- Catches issues before CI/CD

**Pull Requests:**
- Automatic validation on every PR
- Results visible in PR checks
- Blocks merge if violations found

**Production Deployment:**
- Final validation before apply
- Only production environment requires passing all checks
- Ensures compliance in live infrastructure

## Policy Files

The project uses three policy files written in Rego language:

**Location:** `iac/policies/`

**Files:**
- `terraform.rego` - Best practices and configuration standards
- `security.rego` - Security requirements and access controls
- `cost_control.rego` - Cost governance and spending limits

Each policy file contains rules that define what is allowed and what is blocked. Rules are version-controlled alongside infrastructure code.

---

*For detailed implementation and custom policy development, refer to the policy files in `iac/policies/` directory.*
